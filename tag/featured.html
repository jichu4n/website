<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Featured</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?2f610ad0" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html" rel="bookmark">
      How X Window Managers Work, And How To Write One (Part III)
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2017-02-02T23:00:00-08:00">
          Feb 02, 2017
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><!--googleoff: snippet--></p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part I: Basic Concepts</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html"><strong>Part III: Interaction with Application Windows</strong></a>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p><!--googleon: snippet--></p></div>
<div class="paragraph"><p>In <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part
II of this series</a>, we discussed X libraries and implementation choices, and
examined the basic structure of a window manager. In Part III, we will start
interacting with client windows and the user through events. We will review the
fundamentals of window manager implementation, using the implementation in our
example non-compositing reparenting window manager,
<a href="https://github.com/jichu4n/basic_wm">basic_wm</a>, for reference.</p></div>
<div class="sect2">
<h3 id="_step_4_interaction_with_application_windows">Step 4: Interaction with Application Windows</h3>
<div class="paragraph"><p>Following the steps in
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part II
of this series</a>, we now have a basic skeleton for our window manager. Our next
step is to start talking to clients and the user via events.</p></div>
<div class="paragraph"><p>The interaction between clients, X, and the window manager is fairly complex.
To facilitate our discussion, I&#8217;ve created a diagram that illustrates the flow of
events throughout the lifetime of a client window, and how a window manager
might respond to each of them. We&#8217;ll be referring to this cheat sheet for window manager
event handling throughout this series. You can click through for the full-sized diagram.
<div align="center"><a
href="https://docs.google.com/drawings/d/1Bk6s5od7gdeweYtzFRrUvvcm8aHaiAr1Dpaq66WyFhg/pub?w=1843&h=1673"
title="Click for the full-sized diagram"><img
src="https://docs.google.com/drawings/d/1Bk6s5od7gdeweYtzFRrUvvcm8aHaiAr1Dpaq66WyFhg/pub?w=1229&h=1116"
style="max-width: 1229px; width: 100%"></a></div></p></div>
<div class="paragraph"><p>In general, a window manager must handle two kinds of actions: those initiated by client applications (such as creating new windows), and those initiated by users (such as moving or minimizing windows).
In this diagram, actions initiated by client applications are shown in the yellow box on the left hand side, and actions initiated by users are shown in blue on the right hand side.
A window manager communicates with client applications via events, which are represented as parallelograms in red.</p></div>
<div class="paragraph"><p>You may have noticed that some of the events in this diagram have the suffix <em>Request</em>, while others have the suffix <em>Notify</em>. This distinction is crucial to our discussion.</p></div>
<div class="paragraph"><p>Recalling
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#substructure-redirection">our discussion in Part I</a>
on substructure redirection,
when a client application wants to do something with a window (such as moving, resizing, showing, or hiding), its request is redirected to the window manager, which can grant, modify, or deny the request.
Such requests are delivered to a window manager as events with the <em>Request</em> suffix.
It is important to understand that when a window manager receives such an event, the action it represents <em>has not actually occurred</em>, and it is the responsibility of the window manager to decide what to do with it.
If the window manager does nothing, the request is implicitly denied.</p></div>
<div class="paragraph"><p>On the other hand, events with the <em>Notify</em> suffix represent actions that have already been executed by the X server.
The window manager can respond to such events, but of course cannot change the fact that they have already happened.</p></div>
<div class="paragraph"><p>With that in mind, let&#8217;s dive into the implementation by looking at how our example window manager will handle the life cycle of a client window from creation to destruction.</p></div>
<div class="sect3">
<h4 id="_creating_a_window">Creating a Window</h4>
<div class="paragraph"><p>When an X client application creates a top-level window (<a href="http://manpages.ubuntu.com/manpages/xenial/man3/XCreateWindow.3.html"><code>XCreateWindow()</code></a>), our window manager will receive a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XCreateWindowEvent.3.html"><code>CreateNotify</code></a> event. However, a newly created window is always invisible, so there&#8217;s nothing for our window manager to do.
In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// 2. Main event loop.</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="c1">// 1. Get next event.</span>
    <span class="p">...</span>
    <span class="c1">// 2. Dispatch event.</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">CreateNotify</span><span class="p">:</span>
        <span class="n">OnCreateNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xcreatewindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnCreateNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XCreateWindowEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="configuring-a-newly-created-window">Configuring a Newly Created Window</h4>
<div class="paragraph"><p>At this stage, the application can configure the window to set its initial size, position, or other attributes.
To do so, the application would invoke <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XConfigureWindow.3.html"><code>XConfigureWindow()</code></a>,
which would send a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XConfigureRequestEvent.3.html"><code>ConfigureRequest</code></a> event to the window manager.
However, since the window is still invisible, the window manager doesn&#8217;t need to care and can grant such requests without modification by invoking <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XConfigureWindow.3.html"><code>XConfigureWindow()</code></a> itself with the same parameters.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">ConfigureRequest</span><span class="p">:</span>
        <span class="n">OnConfigureRequest</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xconfigurerequest</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnConfigureRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">XConfigureRequestEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">XWindowChanges</span> <span class="n">changes</span><span class="p">;</span>
  <span class="c1">// Copy fields from e to changes.</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">border_width</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">border_width</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">above</span><span class="p">;</span>
  <span class="n">changes</span><span class="p">.</span><span class="n">stack_mode</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">detail</span><span class="p">;</span>
  <span class="c1">// Grant request by calling XConfigureWindow().</span>
  <span class="n">XConfigureWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">value_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">changes</span><span class="p">);</span>
  <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Resize &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">window</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Size</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="mapping-a-window">Mapping a Window</h4>
<div class="paragraph"><p>To make the window finally visible on screen, the client application will call <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XMapWindow.3.html"><code>XMapWindow()</code></a> to <em>map</em> it.
This sends a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a> event to the window manager.
As noted earlier, at this point, the window is still not yet visible, as it&#8217;s up to the window manager to actually make it so. This is probably the most important event in our discussion, as this is where a window manager would usually start really managing a window.</p></div>
<div class="paragraph"><p>A reparenting window manager would typically respond to a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a> for a client application window <em>w</em> with the following actions:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a frame window <em>f</em>, perhaps with borders and window decoration (e.g. title, minimize / maximize / close buttons).
</p>
</li>
<li>
<p>
Register for substructure redirect on <em>f</em> with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XSelectInput.3.html"><code>XSelectInput()</code></a>.
Recall that substructure redirect only applies to direct child windows, so after reparenting, the substructure redirect previously registered on the root window would no longer apply to <em>w</em>, hence this step.
</p>
</li>
<li>
<p>
Make <em>w</em> a child of <em>f</em> with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a>.
</p>
</li>
<li>
<p>
Render <em>f</em> and <em>w</em> with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XMapWindow.3.html"><code>XMapWindow()</code></a>.
</p>
</li>
<li>
<p>
Register for mouse or keyboard shortcuts on <em>w</em> and/or <em>f</em>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The example implementation in <a href="https://github.com/jichu4n/basic_wm">basic_wm</a> will create a very simple frame window that has the same size as the client window, but with a 3px red border:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">MapRequest</span><span class="p">:</span>
        <span class="n">OnMapRequest</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xmaprequest</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnMapRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">XMapRequestEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 1. Frame or re-frame window.</span>
  <span class="n">Frame</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">);</span>
  <span class="c1">// 2. Actually map window.</span>
  <span class="n">XMapWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Frame</span><span class="p">(</span><span class="n">Window</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Visual properties of the frame to create.</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BORDER_WIDTH</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BORDER_COLOR</span> <span class="o">=</span> <span class="mh">0xff0000</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BG_COLOR</span> <span class="o">=</span> <span class="mh">0x0000ff</span><span class="p">;</span>

  <span class="c1">// 1. Retrieve attributes of window to frame.</span>
  <span class="n">XWindowAttributes</span> <span class="n">x_window_attrs</span><span class="p">;</span>
  <span class="n">CHECK</span><span class="p">(</span><span class="n">XGetWindowAttributes</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x_window_attrs</span><span class="p">));</span>

  <span class="c1">// 2. TODO - see Framing Existing Top-Level Windows section below.</span>

  <span class="c1">// 3. Create frame.</span>
  <span class="k">const</span> <span class="n">Window</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">XCreateSimpleWindow</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">root_</span><span class="p">,</span>
      <span class="n">x_window_attrs</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
      <span class="n">x_window_attrs</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
      <span class="n">x_window_attrs</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
      <span class="n">x_window_attrs</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
      <span class="n">BORDER_WIDTH</span><span class="p">,</span>
      <span class="n">BORDER_COLOR</span><span class="p">,</span>
      <span class="n">BG_COLOR</span><span class="p">);</span>
  <span class="c1">// 3. Select events on frame.</span>
  <span class="n">XSelectInput</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">frame</span><span class="p">,</span>
      <span class="n">SubstructureRedirectMask</span> <span class="o">|</span> <span class="n">SubstructureNotifyMask</span><span class="p">);</span>
  <span class="c1">// 4. Add client to save set, so that it will be restored and kept alive if we</span>
  <span class="c1">// crash.</span>
  <span class="n">XAddToSaveSet</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
  <span class="c1">// 5. Reparent client window.</span>
  <span class="n">XReparentWindow</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">w</span><span class="p">,</span>
      <span class="n">frame</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// Offset of client window within frame.</span>
  <span class="c1">// 6. Map frame.</span>
  <span class="n">XMapWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
  <span class="c1">// 7. Save frame handle.</span>
  <span class="n">clients_</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
  <span class="c1">// 8. Grab events for window management actions on client window.</span>
  <span class="c1">//   a. Move windows with alt + left button.</span>
  <span class="n">XGrabButton</span><span class="p">(...);</span>
  <span class="c1">//   b. Resize windows with alt + right button.</span>
  <span class="n">XGrabButton</span><span class="p">(...);</span>
  <span class="c1">//   c. Kill windows with alt + f4.</span>
  <span class="n">XGrabKey</span><span class="p">(...);</span>
  <span class="c1">//   d. Switch windows with alt + tab.</span>
  <span class="n">XGrabKey</span><span class="p">(...);</span>

  <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Framed window &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; [&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">frame</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The outline of the code should be fairly clear following our discussion.
A few additional points to note:</p></div>
<div class="ulist"><ul>
<li>
<p>
Regarding the <em>save-set</em> and <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XAddToSaveSet.3.html"><code>XAddToSaveSet()</code></a>:
</p>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>The save-set is a list of windows, usually maintained by the window manager, but including only windows created by other clients. If the window manager dies, all windows listed in the save-set will be reparented back to their closest living ancestor if they were reparented in the first place and mapped if the window manager has unmapped them so that it could map an icon.</p></div>
<div class="paragraph"><p>The save-set is necessary because the window manager might not exit normally. The user might kill it with CTRL-C if it is running in the foreground, or more likely, the user might get the process number and kill it. Actually, the actions of the save-set are performed even if the window manager exits normally, so less code is needed since the save-set does the cleaning up.</p></div>
<div class="paragraph"><p>Window managers almost always place in the save-set all the windows they reparent or iconify, using <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XAddToSaveSet.3.html"><code>XAddToSaveSet()</code></a>.</p></div>
<div class="paragraph"><p>Windows are automatically removed from the save-set when they are destroyed.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง16.4
</div></div>
</li>
<li>
<p>
When our window manager creates a frame window (step 2 in the example code), it will also trigger a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XCreateWindowEvent.3.html"><code>CreateNotify</code></a> event for the frame window.
It will ignore it just like it ignores other <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XCreateWindowEvent.3.html"><code>CreateNotify</code></a> events as discussed earlier.
</p>
</li>
<li>
<p>
When our window manager calls <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a> in step 5 in the example code,
it will trigger a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XReparentEvent.3.html"><code>ReparentNotify</code></a> event, which it will ignore:
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">ReparentNotify</span><span class="p">:</span>
        <span class="n">OnReparentNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xreparent</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnReparentNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XReparentEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
</pre></div></div></div>
</li>
<li>
<p>
When our window manager calls <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XMapWindow.3.html"><code>XMapWindow()</code></a> to map the frame window (step 6 in the example code),
the X server knows that the action originates from the current window manager, and will execute it directly instead of redirecting it back as a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a> event.
Our window manager will later receive a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapEvent.3.html"><code>MapNotify</code></a> event, which it can ignore:
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">MapNotify</span><span class="p">:</span>
        <span class="n">OnMapNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xmap</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnMapNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XMapEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
</pre></div></div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_configuring_a_mapped_window">Configuring a Mapped Window</h4>
<div class="paragraph"><p>A client application can configure a window that is currently visible, again with the <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XConfigureWindow.3.html"><code>XConfigureWindow()</code></a> function.
For example, an application may want to resize a window to better accomodate its contents.
When a reparenting window manager receives the resulting <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XConfigureRequestEvent.3.html"><code>ConfigureRequest</code></a> and decides to grant the request, it additionally needs to resize / reposition the corresponding frame window and any window decorations.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnConfigureRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">XConfigureRequestEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">XWindowChanges</span> <span class="n">changes</span><span class="p">;</span>
  <span class="c1">// Copy fields from e to changes.</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">clients_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">Window</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">clients_</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">];</span>
    <span class="n">XConfigureWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">value_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">changes</span><span class="p">);</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Resize [&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">frame</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;] to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Size</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Grant request by calling XConfigureWindow().</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>When our window manager re-configures the frame window with the <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XConfigureWindow.3.html"><code>XConfigureWindow()</code></a> call above,
the X server knows that the action originates from the current window manager, and will execute it directly instead of redirecting it back as a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XConfigureRequestEvent.3.html"><code>ConfigureRequest</code></a> event.
Our window manager will then receive a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XConfigureEvent.3.html"><code>ConfigureNotify</code></a> event, which it will ignore:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">ConfigureNotify</span><span class="p">:</span>
        <span class="n">OnConfigureNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xconfigure</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnConfigureNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XConfigureEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_unmapping_a_window">Unmapping a Window</h4>
<div class="paragraph"><p>When a client application <em>unmaps</em> (i.e. hides) a window with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XUnmapWindow.3.html"><code>XUnmapWindow()</code></a>, for example in response to the user exiting or minimizing the application, the window manager will receive a <code>UnmapNotify</code> event.
Unlike the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a> event, the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> event is delivered to the window manager after the fact, and the window manager can only respond to it, not intercept it.</p></div>
<div class="paragraph"><p>A reparenting window manager will typically want to reverse the actions it performed in response to <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a>.
In other words, it would reparent the client window back to the root window, and destroy the corresponding frame window.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">UnmapNotify</span><span class="p">:</span>
        <span class="n">OnUnmapNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xunmap</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnUnmapNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XUnmapEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If the window is a client window we manage, unframe it upon UnmapNotify. We</span>
  <span class="c1">// need the check because we will receive an UnmapNotify event for a frame</span>
  <span class="c1">// window we just destroyed ourselves.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clients_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ignore UnmapNotify for non-client window &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Unframe</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Unframe</span><span class="p">(</span><span class="n">Window</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// We reverse the steps taken in Frame().</span>
  <span class="k">const</span> <span class="n">Window</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">clients_</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
  <span class="c1">// 1. Unmap frame.</span>
  <span class="n">XUnmapWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
  <span class="c1">// 2. Reparent client window back to root window.</span>
  <span class="n">XReparentWindow</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">w</span><span class="p">,</span>
      <span class="n">root_</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// Offset of client window within root.</span>
  <span class="c1">// 3. Remove client window from save set, as it is now unrelated to us.</span>
  <span class="n">XRemoveFromSaveSet</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
  <span class="c1">// 4. Destroy frame.</span>
  <span class="n">XDestroyWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
  <span class="c1">// 5. Drop reference to frame handle.</span>
  <span class="n">clients_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

  <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Unframed window &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">w</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; [&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">frame</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>A few additional points to note:</p></div>
<div class="ulist"><ul>
<li>
<p>
When our window manager unmaps the frame window with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XUnmapWindow.3.html"><code>XUnmapWindow()</code></a> in step 1 in the example code above, it will again receive a corresponding <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> event.
This is the reason why the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> event handler needs to check that the unmapped window is an actual client window.
</p>
</li>
<li>
<p>
When our window manager makes the client window a direct child of the root window with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a> in step 2 above, it will receive a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XReparentEvent.3.html"><code>ReparentNotify</code></a> event.
As discussed in the <a href="#mapping-a-window">Mapping a Window</a> section above, this <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XReparentEvent.3.html"><code>ReparentNotify</code></a> event will be ignored.
</p>
</li>
<li>
<p>
When our window manager destroys the frame window with <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XDestroyWindow.3.html"><code>XDestroyWindow()</code></a> in step 4, it will trigger a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XDestroyWindowEvent.3.html"><code>DestroyNotify</code></a> event.
This event will also be ignored, as shown in the next section.
</p>
</li>
</ul></div>
<div class="paragraph"><p>At this point, the client window has become invisible, but not yet destroyed.
It can be displayed again with a call to <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XMapWindow.3.html"><code>XMapWindow()</code></a>, which would take us back to the <a href="#mapping-a-window">Mapping a Window</a> step.
It could also be reconfigured in this state, which would take us back to the <a href="#configuring-a-newly-created-window">Configuring a Newly Created Window</a> step.</p></div>
</div>
<div class="sect3">
<h4 id="_destroying_a_window">Destroying a Window</h4>
<div class="paragraph"><p>When a client application exits or no longer needs a window, it will call <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XDestroyWindow.3.html"><code>XDestroyWindow()</code></a> to dispose of the window.
This triggers a <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XDestroyWindowEvent.3.html"><code>DestroyNotify</code></a> event.
In our case, there&#8217;s nothing we need to do in response.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">case</span> <span class="nl">DestroyNotify</span><span class="p">:</span>
        <span class="n">OnDestroyNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xdestroywindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnDestroyNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XDestroyWindowEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_framing_existing_top_level_windows">Framing Existing Top-Level Windows</h4>
<div class="paragraph"><p>Now that we&#8217;ve walked through the life cycle of a client window, from creation to destruction, let&#8217;s turn our attention to the problem of existing top-level windows.</p></div>
<div class="paragraph"><p>You may recall from <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part I</a> that X applications in general run just fine without a window manager.
Depending on how an X session is started (e.g. <code>xinitrc</code>), by the time a window manager starts, any number of windows may have already been created by other applications.
Additionally, the user can kill a running window manager and replace it with a different window manager, without affecting windows from other applications.</p></div>
<div class="paragraph"><p>Therefore, when our window manager starts up, it needs to handle any existing top-level windows that are already mapped.
As a reparenting window manager, it will invoke the same <code>Frame()</code> function on such windows as if these windows are being mapped for the first time:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Initialization.</span>
  <span class="c1">//   a. Select events on root window. Use a special error handler so we can</span>
  <span class="c1">//   exit gracefully if another window manager is already running.</span>
  <span class="p">...</span>
  <span class="c1">//   b. Set error handler.</span>
  <span class="p">...</span>
  <span class="c1">//   c. Grab X server to prevent windows from changing under us while we</span>
  <span class="c1">//   frame them.</span>
  <span class="n">XGrabServer</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>
  <span class="c1">//   d. Frame existing top-level windows.</span>
  <span class="c1">//     i. Query existing top-level windows.</span>
  <span class="n">Window</span> <span class="n">returned_root</span><span class="p">,</span> <span class="n">returned_parent</span><span class="p">;</span>
  <span class="n">Window</span><span class="o">*</span> <span class="n">top_level_windows</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_top_level_windows</span><span class="p">;</span>
  <span class="n">CHECK</span><span class="p">(</span><span class="n">XQueryTree</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">root_</span><span class="p">,</span>
      <span class="o">&amp;</span><span class="n">returned_root</span><span class="p">,</span>
      <span class="o">&amp;</span><span class="n">returned_parent</span><span class="p">,</span>
      <span class="o">&amp;</span><span class="n">top_level_windows</span><span class="p">,</span>
      <span class="o">&amp;</span><span class="n">num_top_level_windows</span><span class="p">));</span>
  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">returned_root</span><span class="p">,</span> <span class="n">root_</span><span class="p">);</span>
  <span class="c1">//     ii. Frame each top-level window.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_top_level_windows</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Frame</span><span class="p">(</span><span class="n">top_level_windows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">true</span> <span class="cm">/* was_created_before_window_manager */</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//     iii. Free top-level window array.</span>
  <span class="n">XFree</span><span class="p">(</span><span class="n">top_level_windows</span><span class="p">);</span>
  <span class="c1">//   e. Ungrab X server.</span>
  <span class="n">XUngrabServer</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>

  <span class="c1">// 2. Main event loop.</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnMapRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">XMapRequestEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 1. Frame or re-frame window.</span>
  <span class="n">Frame</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/* was_created_before_window_manager */</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Frame</span><span class="p">(</span><span class="n">Window</span> <span class="n">w</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">was_created_before_window_manager</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// 1. Retrieve attributes of window to frame.</span>
  <span class="p">...</span>
  <span class="c1">// 2. If window was created before window manager started, we should frame</span>
  <span class="c1">// it only if it is visible and doesn&#39;t set override_redirect.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">was_created_before_window_manager</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x_window_attrs</span><span class="p">.</span><span class="n">override_redirect</span> <span class="o">||</span>
        <span class="n">x_window_attrs</span><span class="p">.</span><span class="n">map_state</span> <span class="o">!=</span> <span class="n">IsViewable</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 3. Create frame.</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnUnmapNotify</span><span class="p">(</span><span class="k">const</span> <span class="n">XUnmapEvent</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>

  <span class="c1">// Ignore event if it is triggered by reparenting a window that was mapped</span>
  <span class="c1">// before the window manager started.</span>
  <span class="c1">//</span>
  <span class="c1">// Since we receive UnmapNotify events from the SubstructureNotify mask, the</span>
  <span class="c1">// event attribute specifies the parent window of the window that was</span>
  <span class="c1">// unmapped. This means that an UnmapNotify event from a normal client window</span>
  <span class="c1">// should have this attribute set to a frame window we maintain. Only an</span>
  <span class="c1">// UnmapNotify event triggered by reparenting a pre-existing window will have</span>
  <span class="c1">// this attribute set to the root window.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">root_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ignore UnmapNotify for reparented pre-existing window &quot;</span>
              <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Unframe</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">window</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Some additional things to note:</p></div>
<div class="ulist"><ul>
<li>
<p>
You may notice that the process of framing existing top-level windows is guarded by
<a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XGrabServer.3.html"><code>XGrabServer()</code></a> and <a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XUngrabServer.3.html"><code>XUngrabServer()</code></a>.
From the <em>Xlib Programming Manual</em>:
</p>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>These functions can be used to control processing of output on other connections by the window system server. While the server is grabbed, no processing of requests or close downs on any other connection will occur.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง9.5
</div></div>
<div class="paragraph"><p>By <em>grabbing</em> the X server, our window manager ensures that, between the time when it fetches the list of existing top-level windows and when it finishes framing them, no other application can interfere and mess up our state:
no new windows can be created, and no existing windows can be modified or destroyed.</p></div>
</li>
<li>
<p>
The <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XGetWindowAttributes.3.html"><code>override_redirect</code></a> attribute, if set to true, indicates that a window should not be managed by window managers.
From the <em>Xlib Programming Manual</em>:
</p>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>To control window placement or to add decoration, a window manager often needs to intercept (redirect) any map or configure request.
Pop-up windows, however, often need to be mapped without a window manager getting in the way. [&#8230;]</p></div>
<div class="paragraph"><p>The override-redirect flag specifies whether map and configure requests on this window should override a <code>SubstructureRedirectMask</code> on the parent.
You can set the override-redirect flag to True or False (default).
Window managers use this information to avoid tampering with pop-up windows [&#8230;].</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง3.2.8
</div></div>
<div class="paragraph"><p>The reason our window manager doesn&#8217;t need to check for this attribute except at start up is that the X server knows not to redirect events from such windows:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>The window manager [&#8230;] will normally ignore windows that are mapped with their <code>override_redirect</code> attribute set, since no *Request events will be generated for them.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง16.3
</div></div>
</li>
<li>
<p>
The <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XGetWindowAttributes.3.html"><code>map_state</code></a> attribute indicates whether a window is currently visible (mapped).
When <code>Frame()</code> is invoked for pre-existing windows during start up, we want to ignore windows that are currently unmapped.
However, when <code>Frame()</code> is invoked during the event loop as part of the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapRequestEvent.3.html"><code>MapRequest</code></a> handler, we know that the client window to be framed is necessarily still unmapped,
as our window manager wouldn&#8217;t have granted the request yet.
</p>
</li>
<li>
<p>
You might be wondering why an additional check for <code>e.event == root_</code> is needed in the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> handler.
It turns out that reparenting an already mapped window (<a href="http://manpages.ubuntu.com/manpages/xenial/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a>)
will trigger a pair of <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> and <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XMapEvent.3.html"><code>MapNotify</code></a> events in addition to <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XReparentEvent.3.html"><code>ReparentNotify</code></a>.
Therefore, when we enter into the event loop, we will receive an <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> event for every pre-existing top-level window we reparented.
We can distinguish these events by their <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>event</code></a> attribute, which in this case represents the parent of the client window.
Normally, when a client window we already framed is unmapped, the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>event</code></a> attribute would be its frame window.
But when a pre-existing window is reparented at start up, the <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>event</code></a> attribute in the resulting <a href="http://manpages.ubuntu.com/manpages/xenial/man3/XUnmapEvent.3.html"><code>UnmapNotify</code></a> event will be its original parent - i.e., the root window.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_what_8217_s_next">What&#8217;s Next</h3>
<div class="paragraph"><p>At this point, we have a basic but functional reparenting window manager that will correctly handle the life cycle of windows.
If you strip out window decorations, shortcuts and fancy UI, the core structure of every X window manager will quite closely resemble what we have here.</p></div>
<div class="paragraph"><p>In our next installment, we will improve the user-facing functionality of our window manager by adding ways to move, resize and close windows.
In the meantime, youโre more than welcome to check out the code for <a href="https://github.com/jichu4n/basic_wm">basic_wm</a> on GitHub.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part I: Basic Concepts</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html"><strong>Part III: Interaction with Application Windows</strong></a>
</p>
</li>
</ul></div>
</div></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 02, 2017
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html" rel="bookmark">
      Flashing a Sprint Nexus S 4G to Verizon
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2015-11-11T18:51:00-08:00">
          Nov 11, 2015
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/android.html">Android</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I originally wrote the following post in July 2012 to document how to fully
flash a Nexus S 4G from Sprint to Verizon Wireless, but never got to publishing
it. I have long since switched away from Verizon Wireless and no longer own any
of the phones mentioned, and decided to publish it for what it&#8217;s worth.</p></div>
<div class="paragraph"><p>If you&#8217;re interested in the high-level view of how CDMA phones are programmed,
check out my previous article
<a href="/posts/carrier-programming-on-cdma-android-phones.html">Carrier Programming
on CDMA Android Phones</a>.</p></div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph"><p>This is a guide for flashing a Sprint Samsung Nexus S 4G to a standard Verizon
monthly plan, and voice, texting and 3G data will all be fully functional. This
method will likely also work on many other phones, especially Samsung ones, and
should theoretically work just file on any ROM as well.</p></div>
<div class="paragraph"><p>Note that this procedure entails ESN cloning, which may be illegal in your
region. Please make sure you have an understanding of all applicable laws before
proceeding. The author of this guide cannot be held responsible for any legal
infractions that may ensue. Finally, you are solely responsible for any
consequences of your actions as a result of following this guide. While I
believe it to be quite safe, I cannot guarantee you that this process will not
brick your devices or start a zombie apocalypse.</p></div>
</div>
<div class="sect2">
<h3 id="_requirements_and_setup">Requirements and Setup</h3>
<div class="paragraph"><p>We will need the following before starting:</p></div>
<div class="ulist"><ul>
<li>
<p>
A currently active Verizon Wireless Android phone and plan. Please beware that
  not all phones will work; many phones do not allow us to extract all the
  information we need for this process. For instance, my Motorola Droid 3 did not
  work, and I had to purchase and activate an HTC Incredible for this. This phone
  will be our donor phone.
</p>
</li>
<li>
<p>
A rooted Samsung Nexus 4G.
</p>
</li>
<li>
<p>
A computer running a recent version of Windows, with at least 2 USB ports.
</p>
</li>
<li>
<p>
2 MicroUSB cables.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In addition, we need the following software:</p></div>
<div class="ulist"><ul>
<li>
<p>
USB diagnostic drivers for your donor phone. These vary by manufacturer and
  their configuration may be quite complex; search online for how to set up
  yours.  For HTC phones, download and install HTC Sync from HTCโs website
  (archived <a href="http://www.mediafire.com/?65l9idwgbzq5avb">here</a>).
</p>
</li>
<li>
<p>
USB diagnostic drivers for the Nexus S 4G. The easiest way is to download and
  install PdaNet (archived
  <a href="http://www.mediafire.com/?jjdv8g7ie82kxdx">here</a>). We donโt actually need
  the functionality of PdaNet, but it happens to bundle the drivers we need.
  Select Samsung when prompted for the manufacturer of our phone.
</p>
</li>
<li>
<p>
QPST and QXDM (archived <a href="http://www.mediafire.com/?ojco4qzf4r688k6">here</a>).
  These are internal Qualcomm tools; we will use them to clone the MEID of the
  donor phone.
</p>
</li>
<li>
<p>
DFS (archived <a href="http://www.mediafire.com/?wp7hc8ny854pqrz">here</a>). This is
  a third-party tool for working with CDMA phones. The demo version will
  suffice.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_step_1_preparation">Step 1: Preparation</h3>
<div class="paragraph"><p>First, make sure the donor phone is fully activated and that calls, text and
data are all fully functional.</p></div>
<div class="paragraph"><p>Now, find the HEX MEID of the donor phone. On the HTC Incredible, this can be
found under <em>Settings &#8594; About Phone &#8594; Phone Identity</em>. On most Android phones,
this is under <em>Settings &#8594; About Phone &#8594; Status</em>. It is also usually printed on a
label underneath the phone battery. This should be 14 digits and usually begins
with <code>A00000</code>.</p></div>
<div class="paragraph"><p>Now put the donor phone in airplane mode.</p></div>
<div class="paragraph"><p>We will next connect both phones to the computer in diagnostic mode.</p></div>
<div class="ulist"><ul>
<li>
<p>
On the Nexus S 4G, dial <code>*#*#8778#*#*</code>, then select <em>MODEM</em> under <em>USB</em>.
  Connect the Nexus S 4G to the computer. If drivers were installed correctly,
  you should now see a <em>SAMSUNG Mobile Modem Diagnostic Serial Port (WDM)</em> under
  <em>Ports (COM &amp; LPT)</em> in Windowsโs Device Manager. Note down the port number of
  the Nexus S 4G; we will assume COM4 for convenience.
</p>
</li>
<li>
<p>
On the HTC Incredible, dial <code>##3424#</code>, hit <em>Call</em>,
  connect it to the computer, then follow the instructions in
  <a href="http://forum.xda-developers.com/showthread.php?t=1619314">this thread</a>
  with Device Manager. If everything goes well you should now see a <em>HTC
  Diagnostic Interface</em> under <em>Ports (COM &amp; LPT)</em> in Device Manager. Note down
  the port number of the HTC Incredible; we will assume COM11 for convenience.
</p>
</li>
</ul></div>
<div class="paragraph"><p>After confirming that both phones show up under <em>Ports (COM &amp; LPT)</em>, run QPST
Configuration and hit <em>Add New Port&#8230;</em>. You should see both phones on the left.
Select one and hit OK. Then repeat for the other phone.</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_cloning">Step 2: Cloning</h3>
<div class="paragraph"><p>We will now clone the MEID of the donor phone onto the target phone. Open QXDM
Professional. Select <em>Options &#8594; Communications&#8230;</em>. For <em>Target Port</em>, select the
port corresponding to the Nexus S 4G, say COM4, and hit <em>OK</em>. Then in the text box
labeled <em>Command</em>, type the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Password 01F2030F5F678FF9</code></pre>
</div></div>
<div class="paragraph"><p>Hit <em>Enter</em>. You should see <code>Password Result = Correct</code> at the bottom of the
<em>Command Output</em> window.</p></div>
<div class="paragraph"><p>Now in the <em>Command</em> text box, type the following, replacing <code>&lt;MEID&gt;</code> by the hex
MEID of the <strong>donor</strong> phone:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>RequestNVItemWrite meid 0x&lt;MEID&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Hit <em>Enter</em>. You should see it repeat back the MEID to you. Type
<code>RequestNVItemRead meid</code> followed by <em>Enter</em> to make sure the write happened.</p></div>
<div class="paragraph"><p>Close QXDM Professional and reboot the Nexus S 4G. Rebooting the target phone
after writing a new MEID is essential! If prompted, do NOT go through the
activation process on the Nexus S 4G. Just select <em>Skip</em> when possible.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_reset_spc">Step 3: Reset SPC</h3>
<div class="paragraph"><p>In order to program the Nexus S 4G, we need to obtain or reset the SPC code
(also known as the MSL) of the phones. If you already know the SPC code for your
phones and would rather not reset the SPC code, you can skip this step.</p></div>
<div class="paragraph"><p>Open QXDM Professional again. Go through <em>Options &#8594;
Communications</em> and make sure the <em>Target Port</em> is still COM4. Hit <em>OK</em>. In the
command text box, type the following two lines, each followed by an <em>Enter</em>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Password 01F2030F5F678FF9
RequestNVItemWrite sec_code 000000</code></pre>
</div></div>
<div class="paragraph"><p>If this is successful, the SPC on the Nexus S 4G will have been reset to
<code>000000</code>. Repeat for the donor phone (in our example, on COM11).</p></div>
<div class="paragraph"><p>Close QXDM Professional after done. All QPST / QXDM programs must be closed
before proceeding, or DFS will complain.</p></div>
</div>
<div class="sect2">
<h3 id="_step_4_programming_cdma_chipset">Step 4: Programming CDMA Chipset</h3>
<div class="paragraph"><p>Launch DFS. Click <em>Ports</em> on the top left. In the dialog box, double-click on
each port representing our phones, in our case, COM4 and COM11, and close the
dialog box. Now make sure the <em>SPC</em> text box above reads <code>000000</code> (or if you chose
not to reset the SPC, whatever your SPC is). Type <code>01F2030F5F678FF9</code> into the
<em>Pwd</em> text box.</p></div>
<div class="sect3">
<h4 id="_step_4_a_basic_cdma_settings">Step 4.a: Basic CDMA settings</h4>
<div class="paragraph"><p>Let&#8217;s now copy basic CDMA settings from the donor phone to the
target phone. In the drop-down menu next to <em>Ports</em>, select the donor phone
(COM11). Switch to the <em>Programming</em> tab and the <em>NAM</em> tab under it. Click the
<em>SPC</em> and <em>Pwd</em> buttons to send the SPC and NV password to the phone to unlock
it. Then hit <em>Read</em> beneath <em>Network identification</em>. The text fields below
should be populated by information from the donor phone. Now select COM4 in the
drop-down menu next to <em>Ports</em>, click <em>SPC</em> and <em>Pwd</em>, then click <em>Write</em>
beneath <em>Network identification</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_step_4_b_prl">Step 4.b: PRL</h4>
<div class="paragraph"><p>Now, let&#8217;s copy over the PRL (or <em>Preferred Roaming List</em> - essentially a
database of tower locations). Again, select COM11 under <em>Ports</em> and click <em>Read</em>
under <em>PRL</em> towards the right. Then select COM4 under <em>Ports</em> and click <em>Write</em>
under <em>PRL</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_step_4_c_2g_data_settings">Step 4.c: 2G Data settings</h4>
<div class="paragraph"><p>Now go to the next tab, <em>Data</em>. Select COM11 and hit <em>Read</em>. Switch to COM4 and
hit <em>Write</em>.  If you observe errors in the log window in the bottom, and / or no
information shows up in the <em>Pwd</em> boxes under <em>PPP</em> and <em>HDR AN Long</em>, your
donor phone doesn&#8217;t support the extraction of some data passwords, and you
will have to try a different donor phone.</p></div>
</div>
<div class="sect3">
<h4 id="_step_4_c_3g_data_settings">Step 4.c: 3G Data settings</h4>
<div class="paragraph"><p>We do the same with <em>Mobile IP</em>. Select COM11 and hit <em>Read</em>. Switch to COM4 and
hit <em>Write</em>. Then hit <em>Write current profile settings</em>. Again, if you encounter
errors, or no information shows up under <em>AAA Shared secret</em> and <em>HA Shared
Secret</em>, you will have to try a different donor phone.</p></div>
<div class="paragraph"><p>Finally, we need to copy over a file containing a secret key used to establish a
3G connection. Go to the <em>EFS</em> tab towards the top.  Select COM11 and hit <em>Read
EFS</em>.  Click the "<em>+</em>" sign of the root folder on the left and then the "<em>+</em>"
sign next to the <code>DMU</code> folder and you should see a file called <code>10.key</code>.
Right-click on this file and hit <em>Save&#8230;</em>.  Save this file somewhere on your
hard drive. Now switch to COM4 and hit <em>Read EFS</em> again.  Select the root folder
on the left, type <code>/DMU</code> under <em>Path (57 max)</em> on the right and hit <em>Add Item</em>
to create a folder named <code>DMU</code> on the Nexus S 4G. Then select <code>DMU</code> on the left,
click on the check box named <em>I want to add file from PC</em>, and select the
<code>10.key</code> file we just saved. Then hit <em>Add Item</em> to upload the <code>10.key</code> file to
<code>/DMU/10.key</code>.</p></div>
<div class="paragraph"><p>The programming is now done. Close DFS, select <em>OK</em> and <em>OK</em> again when prompted
whether to send a <em>mode reset</em> to the phone. The Nexus S 4G will now reboot.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_5_programming_android">Step 5: Programming Android</h3>
<div class="paragraph"><p>We will now modify some Android system files to Verizon settings. This step will
need to be repeated whenever you flash a new ROM on the Nexus S 4G in the
future.</p></div>
<div class="sect3">
<h4 id="_1_click_programming_app">1-click programming app</h4>
<div class="paragraph"><p>I have built a 1-click Android application that automates this step; you can
find it <a href="http://www.mediafire.com/?m796blddz3g8ifd">here</a>. It requires root
as it will need to modify system files. Install the application and click the
button in the middle. When the process finishes, you will be prompted to reboot.
Simply reboot your phone and youโre all set; you may uninstall the app, or you
could keep it around for when you update to a new ROM.</p></div>
<div class="paragraph"><p>If the 1-click app does not work for you, or if you want more control over what
it does, follow the steps below. You do not need to do any of the following if
you already used the app above.</p></div>
</div>
<div class="sect3">
<h4 id="_step_5_a_fix_voice_calling">Step 5.a: Fix voice calling</h4>
<div class="paragraph"><p>This is required to enable calls on Verizon.
On the Nexus S 4G, connect to WiFi and install ES File Explorer from the Play
Store. Then go to <em>Menu &#8594; Settings</em> and check <em>Up to Root</em>, <em>Root Explorer</em>, and
<em>Mount File System</em>. Allow it to use superuser privileges if asked. Then
navigate to <code>/system</code> and open <code>build.prop</code> with <em>ES Note Editor</em>. Find the
following two lines:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310120
ro.cdma.home.operator.alpha=Sprint</code></pre>
</div></div>
<div class="paragraph"><p>Change them to read:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310004
ro.cdma.home.operator.alpha=Verizon</code></pre>
</div></div>
<div class="paragraph"><p>Then add a line below (or anywhere in the file) that says:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.homesystem=64,65,76,77,78,79,80,81,82,83</code></pre>
</div></div>
<div class="paragraph"><p>Hit <em>Menu &#8594; Save</em> and then <em>Back</em> to exit.</p></div>
</div>
<div class="sect3">
<h4 id="_step_5_b_fix_roaming">Step 5.b: Fix roaming</h4>
<div class="paragraph"><p>This step tells Android to treat the Verizon network as the home network. It
sets the roaming status to "Not roaming", removes the triangular roaming
indicator in the status bar and changes the displayed name of the current
network to "Verizon Wireless".</p></div>
<div class="paragraph"><p>Now navigate to <code>/system/framework</code> and copy <code>framework-res.apk</code> onto your
computer - you can use adb or email it to yourself or whatever (you have to copy
it to the internal SD card before you can email it though). Once on the
computer, rename it <code>framework-res.zip</code> (yes, an APK is just a zip archive) and
use your favorite program to replace the file <code>res/xml/eri.xml</code> inside it with
the one at <a href="http://www.mediafire.com/?jdsigtxi4gvp6ks">this link</a>. Now rename
it back to <code>framework-res.apk</code>, copy it back
onto the Nexus S 4G (using adb or whatever) and use ES File Explorer to
overwrite the existing <code>/system/framework/framework-res.apk</code> with it.</p></div>
</div>
<div class="sect3">
<h4 id="_step_5_c_add_verizon_apns">Step 5.c: Add Verizon APNs</h4>
<div class="paragraph"><p>This last step sets up Verizon APNs that enable web and MMS. Use ES File
Explorer or any other tool to replace <code>/system/etc/apns-conf.xml</code> with the one
at <a href="http://www.mediafire.com/?g0vd7nfs47ksujz">this link</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_6_reboot_amp_profit">Step 6: Reboot &amp; PROFIT</h3>
<div class="paragraph"><p>The Nexus S 4G should now be a fully functional Verizon Wireless phone. If you
are curious about what each of the steps means, you&#8217;re welcome to check out my
previous article
<a href="/posts/carrier-programming-on-cdma-android-phones.html">Carrier Programming
on CDMA Android Phones</a> for a high-level view of how CDMA phones are programmed.</p></div>
<div class="paragraph"><p>While your mileage may vary, I hope the above information have been of help.
Since I no longer use Verizon Wireless and no longer own any of the phones
mentioned above, please take all this information with a grain of salt.</p></div>
<div class="paragraph"><p>Good luck, and happy hacking!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 11, 2015
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/android.html">Android</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html" rel="bookmark">
      Custom Domain E-mails With Postfix and Gmail: The Missing Tutorial
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-11-06T16:50:00-08:00">
          Nov 06, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/misc.html">Misc</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Custom domain e-mail addresses, like <code>john@johnscompany.com</code>, are cool and
professional-looking. Would <em>you</em> want to e-mail potential clients as
<code>john123@gmail.com</code>?</p></div>
<div class="paragraph"><p>On the other hand, Gmail has great reliability, speed, spam filtration, and app
support. Wouldn&#8217;t it be great if we could send and receive e-mail as
<code>john@johnscompany.com</code>, but right from the comfort of our Gmail account?</p></div>
<div class="paragraph"><p>Today, if we want to <strong>use Gmail to send and receive e-mails on a custom domain</strong>,
we have a couple of options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong><a href="http://www.google.com/work/apps/business/">Google Apps for Work</a></strong> is Google&#8217;s
  own offering. It&#8217;s simple to set up and manage, but it&#8217;s pretty pricey at
  $5/mo per user, especially if we don&#8217;t need the bundled collaborative
  features like Google Docs and Calendar.
</p>
</li>
<li>
<p>
<strong>Third-party services</strong> could get the job done at a
  lower price point; for example, <a href="https://pobox.com/">Pobox</a> offers plans
  starting at $20/yr. The downside is that we will have to trust another
  organization with our e-mail.
</p>
</li>
<li>
<p>
<strong>Set up our own e-mail forwarding server</strong>. It&#8217;s fairly easy (if we
  follow this guide :) and if we already have shared / dedicated hosting or a
  VPS, this is basically free and gives us total control over our e-mail.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you want to host <strong>custom domain e-mails in Gmail without paying for Google
Apps</strong> or a third-party service, this tutorial is for you. It will show you how
to quickly set up you own e-mail forwarding / relay server, and how to integrate
it seamlessly with Gmail.</p></div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph"><p>For this tutorial, we&#8217;ll assume we have access to:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>VPS or shared / dedicated hosting</strong>, with a dedicated IP address and capable
  of listening on ports 25 and 587. We will use a Ubuntu server for
  the examples.
</p>
</li>
<li>
<p>
<strong>DNS records for our domain</strong>. How DNS records are manipulated depends on the
  DNS hosting provider (or DNS server configuration).
</p>
</li>
</ul></div>
<div class="paragraph"><p>We&#8217;ll assume</p></div>
<div class="ulist"><ul>
<li>
<p>
We have a domain <code>example.com</code>;
</p>
</li>
<li>
<p>
We have a server <code>myserver.example.com</code>;
</p>
</li>
<li>
<p>
We want to use the Gmail account <code>john123@gmail.com</code> to manage
  <code>john@example.com</code>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_step_1_dns_setup">Step 1: DNS Setup</h3>
<div class="paragraph"><p>The first step in setting up our e-mail forwarding server is to add MX, PTR and
<a href="http://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> DNS records for our
server. This is really important as many e-mail providers, in order to prevent
spam, will refuse to talk to mail servers without proper MX, PTR and SPF records
set up. How to update DNS records will depend on the DNS hosting provider.</p></div>
<div class="paragraph"><p>The following is what we need:</p></div>
<div class="ulist"><ul>
<li>
<p>
An <strong>MX</strong> record for <code>example.com</code>, pointing to <code>myserver.example.com</code>.
</p>
<div class="paragraph"><p>This tells the world that e-mails to <code>&lt;whatever&gt;@example.com</code> should be
delivered to the server <code>myserver.example.com</code>.</p></div>
</li>
<li>
<p>
An <strong>A</strong> record for <code>myserver.example.com</code>, pointing to the IP address of our
  server.
</p>
</li>
<li>
<p>
A <strong>PTR</strong> (reverse DNS) record mapping the IP address of our server to
  <code>myserver.example.com</code>.
</p>
<div class="paragraph"><p>This allows Gmail to verify the legitimacy of our server via its IP when Gmail
receives a forwarded e-mail from it.</p></div>
</li>
<li>
<p>
A <strong>TXT</strong> record, with key <code>example.com</code> and value <code>v=spf1 mx ~all</code>.
</p>
<div class="paragraph"><p>This is an <a href="http://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> record; it
tells Gmail that the servers specified in the MX records of <code>example.com</code>, in
this case only <code>myserver.example.com</code>, are allowed to send e-mails purporting to
be from <code>&lt;whatever&gt;@example.com</code>. All other servers attempting to do the same
will be rejected. This should be a sane default value, but feel free to custom
it as you like.</p></div>
</li>
</ul></div>
<div class="paragraph"><p>DNS records will take a while (depending on our provider, up to a day) to
propagate. Until they do, e-mails forwarded by our new e-mail server may get
marked as spam or rejected outright.</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_receiving_e_mail">Step 2: Receiving E-mail</h3>
<div class="paragraph"><p>We&#8217;ll first set up an e-mail forwarding server which will let we receive e-mails
sent to our domains.</p></div>
<div class="paragraph"><p>We will use <a href="http://www.postfix.org">Postfix</a> as the e-mail server. Let&#8217;s start by
installing the necessary packages. We will assume a Ubuntu server in the
examples below; if you&#8217;re using a different distribution, please consult your
distribution&#8217;s documentation for the right commands.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ sudo DEBIAN_FRONTEND=noninteractive apt-get install postfix</code></pre>
</div></div>
<div class="paragraph"><p>In the above command, we skip the <code>debconf</code> configuration UI with
<code>DEBIAN_FRONTEND=noninteractive</code> as we will edit the configuration files
directly.</p></div>
<div class="sect3">
<h4 id="_etc_postfix_main_cf">/etc/postfix/main.cf</h4>
<div class="paragraph"><p>Open up <code>/etc/postfix/main.cf</code> in your favorite editor. This file will come
pre-populated with a bunch of config options and comments.  Replace the contents
of the file with the following (you can comment out the original contents for
reference):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># /etc/postfix/main.cf</span>

<span class="c"># Host and site name.</span>
<span class="n">myhostname</span> <span class="o">=</span> <span class="n">myserver</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">mydomain</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">myorigin</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="c"># Virtual aliases.</span>
<span class="n">virtual_alias_domains</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">virtual_alias_maps</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">virtual</span>
</pre></div></div></div>
<div class="paragraph"><p>The first few lines are pretty straightforward; they tell Postfix how to
identify itself to the world. The last two lines tell Postfix to forward e-mails
sent to <code>&lt;whatever&gt;@example.com</code> to another e-mail provider (Gmail), and that the
forwarding is configured in the database file <code>/etc/postfix/virtual</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_etc_postfix_virtual">/etc/postfix/virtual</h4>
<div class="paragraph"><p>Let&#8217;s now open up <code>/etc/postfix/virtual</code> and fill in our forwarding
configuration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># /etc/postfix/virtual</span>

<span class="c"># Forwarding mapping, one from-to address pair per line. The format is:</span>
<span class="c">#     &lt;forward-from-addr&gt; &lt;whitespace&gt; &lt;forward-to-addr&gt;</span>
john@example.com        john123@gmail.com
</pre></div></div></div>
<div class="paragraph"><p>We can add as many forwarding rules as you want, one on each line.  We can use
any number of tabs / whitespaces between the forward-from and forward-to
addresses.</p></div>
</div>
<div class="sect3">
<h4 id="_update_lookup_table">Update lookup table</h4>
<div class="paragraph"><p>It turns out that Postfix doesn&#8217;t actually read <code>/etc/postfix/virtual</code>
(surprise!); instead, what it reads is a lookup table generated from it.
So, let&#8217;s generate the lookup table from our <code>/etc/postfix/virtual</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postmap /etc/postfix/virtual
</pre></div></div></div>
<div class="paragraph"><p><strong>Note</strong>: we must re-run this command every time we modify
<code>/etc/postfix/virtual</code>!</p></div>
</div>
<div class="sect3">
<h4 id="_re_start_postfix">(Re)start Postfix</h4>
<div class="paragraph"><p>It&#8217;s now time to (re)start Postfix with our new configuration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postfix start
<span class="nv">$ </span>sudo postfix reload
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_testing">Testing</h4>
<div class="paragraph"><p>We should test our brand-new Postfix server by sending an e-mail to our
forward-from address. You might want to check out
<a href="http://articles.slicehost.com/2008/8/6/postfix-using-telnet-to-test-postfix">these</a>
<a href="https://workaround.org/ispmail/lenny/test-mail-through-telnet">tutorials</a> for
testing directly with the <code>telnet</code> command.</p></div>
<div class="paragraph"><p>If you received the e-mail in your Gmail inbox, congratulations! Otherwise,
check the Postfix logs at <code>/var/log/mail.log</code> (or with <code>journalctl -u postfix</code>
if using Systemd) for errors. The most likely cause of issues is that DNS
records have not propagated yet, in which case we&#8217;re likely to see a "rate
limited" or "rejected for spam" type error message.</p></div>
<div class="paragraph"><p>If we only want to <em>receive</em> but don&#8217;t care about <em>sending</em> e-mails as
<code>john@example.com</code>, then this is all we need.</p></div>
<div class="paragraph"><p>Otherwise, let&#8217;s move on to
configuring Postfix to support sending e-mails from Gmail.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_sending_e_mail">Step 3: Sending E-mail</h3>
<div class="paragraph"><p>Gmail requires a relay server (a server that will send e-mails to their
destination on behalf it) to speak
<a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>, which protects the
communication between Gmail and the relay server.</p></div>
<div class="paragraph"><p>We will use <a href="http://www.cyrusimap.org/">Cyrus SASL</a> for this task. To install:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install sasl2-bin libsasl2-modules
</pre></div></div></div>
<div class="sect3">
<h4 id="_user_name_amp_password">User name &amp; password</h4>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Open_mail_relay">Open relays</a> are a terrible idea.
We want to protect our e-mail server with a user name and password so that it
will let Gmail send e-mails through it, but block spammers and other evil
actors.</p></div>
<div class="paragraph"><p>Cyrus SASL supports several backends for storing user names and passwords,
including MySQL and PAM. However, we will go with the simplest backend&#8201;&#8212;&#8201;a
plain database file.</p></div>
<div class="paragraph"><p>Let&#8217;s create the user name / password database file in the default location
<code>/etc/sasldb2</code>, with a single user named <code>smtp</code> (we can change the user name to
anything we want):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo saslpasswd2 -c -u example.com smtp
</pre></div></div></div>
<div class="paragraph"><p>Verify with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo sasldblistusers2
</pre></div></div></div>
<div class="paragraph"><p>Now, we make sure only Postfix can read this file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo chmod <span class="m">400</span> /etc/sasldb2
<span class="nv">$ </span>sudo chown postfix /etc/sasldb2
</pre></div></div></div>
<div class="paragraph"><p>Lastly, we tell Cyrus SASL to use the file-based database to authenticate.
Create the file <code>/etc/postfix/sasl/smtpd.conf</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pwcheck_method: auxprop
auxprop_plugin: sasldb
mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5 NTLM
log_level: 7</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_ssl_certificate">SSL Certificate</h4>
<div class="paragraph"><p>We need an SSL certificate to enable TLS. While a proper SSL certificate signed
by a Certificate Authority (CA) can be pricey, it turns out that a simple
self-signed certificate suffices and works just fine.</p></div>
<div class="paragraph"><p>So, let&#8217;s generate one.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Generate an RSA private/public key pair.</strong> Note that you MUST supply a password
  to this command; the password will be removed in step 3.
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl genrsa -des3 -out example.key 1024
</pre></div></div></div>
</li>
<li>
<p>
<strong>Generate a Certificate Signing Request (CSR).</strong> Make sure to enter
  <code>myserver.example.com</code> when prompted for the "Common Name".
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl req -new -key example.key -out example.csr
</pre></div></div></div>
</li>
<li>
<p>
<strong>Remove RSA private/public key password.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mv example.key example.key.orig
<span class="nv">$ </span>openssl rsa -in example.key.orig -out example.key
</pre></div></div></div>
</li>
<li>
<p>
<strong>Generate a self-signed certificate.</strong> In the example, the generated
  certificate will be valid for 10 years.
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl x509 -req <span class="se">\</span>
    -days <span class="m">3650</span> -in example.csr -signkey example.key -out example.crt
</pre></div></div></div>
</li>
<li>
<p>
<strong>Create a PEM file.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>cat example.crt example.key &gt; example.pem
</pre></div></div></div>
</li>
<li>
<p>
<strong>Move and protect the PEM file.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo mv example.pem /etc/postfix/example.pem
<span class="nv">$ </span>sudo chmod <span class="m">400</span> /etc/postfix/example.pem
<span class="nv">$ </span>sudo chown postfix /etc/postfix/example.pem
</pre></div></div></div>
</li>
</ol></div>
<div class="paragraph"><p><strong>Note:</strong> Make sure to protect the generated private key and certificate with care!</p></div>
</div>
<div class="sect3">
<h4 id="_relay_server">Relay server</h4>
<div class="paragraph"><p>The final step is to configure Postfix to enable relaying of e-mail on behalf of
Gmail.</p></div>
<div class="paragraph"><p>Let&#8217;s open up <code>/etc/postfix/master.cf</code>. This file should already contain a bunch
of config options, some of which are commented out. Uncomment the lines starting
with <code>submission</code> and edit them to match the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>submission inet n       -       n       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=may
  -o smtpd_tls_cert_file=/etc/postfix/example.pem
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_reject_unlisted_recipient=no
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING</code></pre>
</div></div>
<div class="paragraph"><p>A Postfix restart is due after all these changes:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postfix reload
</pre></div></div></div>
<div class="paragraph"><p>If all went well, you should see Postfix serving a relay server, protected by
our user name and password in <code>/etc/sasldb2</code>, on port 587.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_configure_gmail">Step 4: Configure Gmail</h3>
<div class="paragraph"><p>Finally, let&#8217;s log in to Gmail and tell it about our brand new server. (Note
that the new Inbox UI does not yet support all the settings available in the
legacy interface at the time of writing, so these instructions apply to the
legacy interface.)</p></div>
<div class="paragraph"><p>Let&#8217;s go to <em>Settings</em> &gt; <em>Accounts and Import</em> and click <em>Add another email
address you own</em>.
<div align="center"><img src="/assets/files/gmail_1.png"></div>
In the dialog that pops up, fill in our target e-mail address and click <em>Next
Step</em>.
<div align="center"><img src="/assets/files/gmail_2.png"></div>
In the next dialog, enter the address of our e-mail server
(<code>myserver.example.com</code>), and the user name and password we set up using
<code>saslpasswd2</code> above. Make sure the user name is suffixed with our domain name
(so <code>smtp@example.com</code> rather than just <code>smtp</code>). Check that the correct port
(587) and the correct security protocol (TLS) are selected, then click <em>Add
Account</em>.
<div align="center"><img src="/assets/files/gmail_3.png"></div>
If all goes well, we should see a dialog like the following:
<div align="center"><img src="/assets/files/gmail_4.png"></div>
And we should receive an e-mail, forwarded by our mail server set up in the
first part, to our <code>john123@gmail.com</code> address. Click on the link inside the
e-mail and we&#8217;re done!</p></div>
<div class="paragraph"><p>Now, in any e-mail compose / reply window, you should be able to select
<code>john@example.com</code> in the drop-down list next to "From". Congrats!</p></div>
<div class="paragraph"><p>If, on the other hand, you see an error like the following:
<div align="center"><img src="/assets/files/gmail_5.png"></div>
You should check the Postfix logs at <code>/var/log/mail.log</code> (or with <code>journalctl -u
postfix</code> if using Systemd) for any errors.</p></div>
</div>
<div class="sect2">
<h3 id="_optional_step_5_setup_dkim_and_srs">[Optional] Step 5: Setup DKIM and SRS</h3>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DKIM</a>, short for
<em>DomainKeys Identified Mail</em>, is e-mail validation system for preventing e-mail
spoofing. <a href="https://support.google.com/mail/answer/180707?hl=en">Google recommends
setting up DKIM</a>; if we don&#8217;t, the e-mail messages that we forward to Gmail have
a higher probability of getting marked as spam.</p></div>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Sender_Rewriting_Scheme">SRS</a>, short for <em>Sender
Rewriting Scheme</em>, is a relatively new standard that e-mail forwarding servers
are recommended to adopt, and it also helps reduce the likelihood of our
forwarded e-mail messages getting marked as spam.</p></div>
<div class="paragraph"><p>Thus, while technically optional, it&#8217;s a good idea to configure our Postfix
server to support both these standards. See my follow-up tutorial on
<a href="/posts/setting-up-dkim-and-srs-in-postfix.html">Setting Up DKIM And SRS In
Postfix</a> for a detailed step-by-step guide.</p></div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph"><p>In this post, we have set up a Postfix e-mail server that accomplishes the
following:</p></div>
<div class="ulist"><ul>
<li>
<p>
E-mails sent to <code>john@example.com</code> is received by Postfix on
  <code>myserver.example.com</code> port 25, and forwarded to <code>john123@gmail.com</code>;
</p>
</li>
<li>
<p>
Gmail will let you select <code>john@example.com</code> as a "from" address when
  composing / replying to an e-mail, and will relay such e-mails through Postfix
  on <code>myserver.example.com</code> port 587 using a configured user name / password
  combination.
</p>
</li>
</ul></div>
<div class="paragraph"><p>I hope you found this guide useful, and if you have any thoughts / questions,
you&#8217;re more than welcome to leave a comment below. Cheers!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 06, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/misc.html">Misc</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html" rel="bookmark">
      How X Window Managers Work, And How To Write One (Part II)
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-06-08T23:14:00-07:00">
          Jun 08, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><!--googleoff: snippet--></p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part I: Basic Concepts</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html"><strong>Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</strong></a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">Part III: Interaction with Application Windows</a>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p><!--googleon: snippet--></p></div>
<div class="paragraph"><p>In <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part
I of this series</a>, we examined the role of X window managers in a modern
Linux/BSD desktop environment, and how they interact with the X server and
applications. In Part II, we will dig into the dirty details and walk through
the code of an example reparenting non-compositing window manager,
<a href="https://github.com/jichu4n/basic_wm">basic_wm</a>.</p></div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph"><p>Before we start with the code, let&#8217;s go over a couple of basic implementation
choices such as language and API.</p></div>
<div class="sect3">
<h4 id="_language">Language</h4>
<div class="paragraph"><p>You can write a window manager in <a href="http://xmonad.org">Haskell</a>,
<a href="http://qtile.org">Python</a>, <a href="http://www.nongnu.org/stumpwm/">Lisp</a>,
<a href="https://github.com/BurntSushi/wingo">Go</a>,
<a href="http://escher.sourceforge.net/">Java</a>, or any other language that has X bindings,
i.e. a library for communicating with X servers.</p></div>
<div class="paragraph"><p>I chose C++ for <a href="https://github.com/jichu4n/basic_wm">basic_wm</a>, our example
window manager, mainly because the C libraries for X11 are the best documented.
In addition to books such as the
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual</a>, documentation can be found in the form of widely available
<a href="http://www.xfree86.org/current/manindex3.html">man pages</a> (e.g., try <code>man
XOpenDisplay</code> at a terminal). Example usage and common patterns abound in the
source code of many great window managers written in the past three decades.</p></div>
<div class="paragraph"><p>We will use C++11 and C++14 features where convenient, so you will need a
compatible compiler (GCC 4.9 or higher, or Clang 3.4 or higher) if you want to
play with the example source code.</p></div>
</div>
<div class="sect3">
<h4 id="a-tale-of-two-x-libraries">A Tale of Two X Libraries</h4>
<div class="paragraph"><p>There are two official C libraries for X:
<a href="http://en.wikipedia.org/wiki/Xlib">Xlib</a> and
<a href="http://en.wikipedia.org/wiki/Xcb">XCB</a>. Xlib, hailing from 1985, was the original
X client library, and was the only official X client library until the
introduction of XCB in 2001. The two libraries have very different philosophies:
whereas Xlib tries to hide the X protocol behind a friendly C API with lots of
bells and whistles, XCB directly exposes the plumbing beneath.</p></div>
<div class="paragraph"><p>In practice, this different manifests itself most prominently in how the two
libraries handle the fundamental asynchronous nature of X&#8217;s client-server
architecture. Xlib attempts to hide the asynchronous X protocol behind a mixed
synchronous and asynchronous API, whereas XCB exposes a fully asynchronous API.</p></div>
<div class="paragraph"><p>For example, to lookup the attributes (e.g., size and position) of a window, you
would write the following code using Xlib:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">XWindowAttributes</span> <span class="n">attrs</span><span class="p">;</span>
<span class="n">XGetWindowAttributes</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">);</span>
<span class="c1">// Do stuff.</span>
</pre></div></div></div>
<div class="paragraph"><p>Under the hood,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XGetWindowAttributes.3.html"><code>XGetWindowAttributes</code>()</a>
sends a request to the X server and blocks until it receives a response; in
other words, it is <em>synchronous</em>. On the other hand, using XCB, you would write
this instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">xcb_get_window_attributes_cookie_t</span> <span class="n">cookie</span> <span class="o">=</span>
    <span class="n">xcb_get_window_attributes</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
<span class="c1">// Do other stuff while waiting for reply.</span>
<span class="kt">xcb_get_window_attributes_reply_t</span><span class="o">*</span> <span class="n">reply</span> <span class="o">=</span>
    <span class="n">xcb_get_window_attributes_reply</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
<span class="c1">// Do stuff.</span>
<span class="n">free</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>The function <code>xcb_get_window_attributes</code> merely sends the request to the X
server, and returns immediately without waiting for the reply; in other words,
it is <em>asynchronous</em>. The client program must subsequently call
<code>xcb_get_window_attributes_reply</code> to block on the response.</p></div>
<div class="paragraph"><p>The advantage of the asynchronous approach is obvious if we consider an example
where we need to retrieve the attributes of, say, 5 windows at once. Using XCB,
we can immediately fire off all 5 requests to the X server, and then wait for
all of them to return. With Xlib, we have send one request at a time and wait
for its response to come back before we can send the next request. Therefore,
we&#8217;d expect to only block for the duration of one round-trip to the X server
using XCB, compared to 5 with Xlib.</p></div>
<div class="paragraph"><p>The downside of XCB&#8217;s fully asynchronous approach is verbosity and a less
programmer-friendly interface.  The Xlib code above looks like your average C
library call; the XCB code above is significantly more involved.</p></div>
<div class="paragraph"><p>However, it is important to note that Xlib isn&#8217;t fully synchronous. Rather,
<strong>Xlib has a mixture of synchronous and asynchronous APIs</strong>. In general, functions
that do not return values (e.g.,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XConfigureWindow.3.html">XResizeWindow</a>,
which changes the size of a window) are asynchronous, while functions that
return values (e.g.,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XGetWindowAttributes.3.html">XGetGeometry</a>,
which return the size and position of a window) are synchronous:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Xlib saves up requests instead of sending them to the server immediately, so
that the client program can continue running instead of waiting to gain access
to the network after every Xlib call. This is possible because most Xlib calls
do not require immediate action by the server. This grouping of requests by the
client before sending them over the network also increases the performance of
most networks, because it makes the network transactions longer and less
numerous, reducing the total overhead involved.</p></div>
<div class="paragraph"><p>Xlib sends the buffer full of requests to the server under three conditions.</p></div>
<div class="paragraph"><p>The most common is when an application calls an Xlib routine to wait for an
event but no matching event is currently available on Xlibโs queue. Since, in
this case, the application must wait for an appropriate event anyway, it makes
sense to flush the request buffer.</p></div>
<div class="paragraph"><p>Second, Xlib calls that get information from the server require a reply before
the program can continue, and therefore, the request buffer is sent and all the
requests acted on before the information is returned.</p></div>
<div class="paragraph"><p>Third, the client would like to be able to flush the request buffer manually in
situations where no user events and no calls to query the server are expected.
One good example of this third case is an animated game, where the display
changes even when there is no user input.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง2.1.2
</div></div>
<div class="paragraph"><p>This is <em>the</em> most confusing aspect of Xlib, and a source of endless frustration
for those new to X programming. One of the major motivations for the creation of
XCB was to eliminate this complexity.</p></div>
<div class="paragraph"><p>Many popular window managers have already been ported to XCB from Xlib for the
performance benefits. If you are interested, you can read up on how the
<a href="http://www.mini-dweeb.org/~arnau/docs/dueti/project/report.pdf">Awesome</a> and
<a href="http://blog.martin-graesslin.com/blog/2013/02/porting-kwin-to-xcb-making-c-usable-through-raii/">KWin</a>
window managers were ported to XCB.</p></div>
<div class="paragraph"><p>I chose to use Xlib for <a href="https://github.com/jichu4n/basic_wm">basic_wm</a>, however,
because as a pedagogical example, readability and simplicity is much more
important than performance. In fact, I would recommend starting with Xlib first
for any project and worry about porting to XCB later, as Xlib is much easier to
learn and prototype with.</p></div>
<div class="paragraph"><p>While an in-depth discussion of the merits of Xlib and XCB is beyond the scope
of this discussion, I do recommend you check out
<a href="http://www.x.org/wiki/guide/xlib-and-xcb/">the official article on Xlib vs. XCB</a>
as it presents a fascinating case study of API design.</p></div>
</div>
<div class="sect3">
<h4 id="_dependencies_and_building">Dependencies and Building</h4>
<div class="paragraph"><p>Firstly, you will need Xlib development headers in order to compile against
Xlib. They are available on Debian/Ubuntu as <code>libx11-dev</code>, on Fedora as
<code>libX11-devel</code>, and on Arch Linux as part of <code>libx11</code>.</p></div>
<div class="paragraph"><p>The only additional library used by the example
<a href="https://github.com/jichu4n/basic_wm">basic_wm</a> code is
<a href="https://code.google.com/p/google-glog/">google-glog</a>, Google&#8217;s open source C++
logging library. It is available on Debian/Ubuntu as <code>libgoogle-glog-dev</code>, on
Fedora as <code>glog-devel</code>, and on Arch Linux as <code>google-glog</code>.</p></div>
<div class="paragraph"><p>The recommended way to build the source code is with
<a href="https://www.gnu.org/software/make/manual/html_node/Running.html">GNU Make</a>: just
run <code>make</code> in the source directory.  Alternatively, <code>g++ *.cpp</code> will also do the
trick if you supply all the libraries correctly.</p></div>
<div class="paragraph"><p>To test the window manager, you will likely need
<a href="http://www.freedesktop.org/wiki/Software/Xephyr/">Xephyr</a> along with a couple of
simple X programs such as <code>xeyes</code> or <code>xterm</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_setup_and_teardown">Step 1: Setup and Teardown</h3>
<div class="paragraph"><p>Let&#8217;s start off with a skeleton implementation of the <code>WindowManager</code> class,
which will encapsulate all the window management logic in our example. All it
will do for now is set up a connection to the X server on construction, and
close that connection on destruction.</p></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.hpp"><code>window_manager.hpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#include &lt;X11/Xlib.h&gt;</span>
<span class="p">}</span>
<span class="cp">#include &lt;memory&gt;</span>

<span class="k">class</span> <span class="nc">WindowManager</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">// Factory method for establishing a connection to an X server and creating a</span>
  <span class="c1">// WindowManager instance.</span>
  <span class="k">static</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">Create</span><span class="p">();</span>
  <span class="c1">// Disconnects from the X server.</span>
  <span class="o">~</span><span class="n">WindowManager</span><span class="p">();</span>
  <span class="c1">// The entry point to this class. Enters the main event loop.</span>
  <span class="kt">void</span> <span class="nf">Run</span><span class="p">();</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// Invoked internally by Create().</span>
  <span class="n">WindowManager</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">);</span>

  <span class="c1">// Handle to the underlying Xlib Display struct.</span>
  <span class="n">Display</span><span class="o">*</span> <span class="n">display_</span><span class="p">;</span>
  <span class="c1">// Handle to root window.</span>
  <span class="k">const</span> <span class="n">Window</span> <span class="n">root_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#include &quot;window_manager.hpp&quot;</span>
<span class="cp">#include &lt;glog/logging.h&gt;</span>

<span class="k">using</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="p">;</span>

<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Create</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Open X display.</span>
  <span class="n">Display</span><span class="o">*</span> <span class="n">display</span> <span class="o">=</span> <span class="n">XOpenDisplay</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to open X display &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">XDisplayName</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 2. Construct WindowManager instance.</span>
  <span class="k">return</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">WindowManager</span><span class="p">(</span><span class="n">display</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">WindowManager</span><span class="o">::</span><span class="n">WindowManager</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">display_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">display</span><span class="p">)),</span>
      <span class="n">root_</span><span class="p">(</span><span class="n">DefaultRootWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">))</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">WindowManager</span><span class="o">::~</span><span class="n">WindowManager</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">XCloseDisplay</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* TODO */</span> <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <code>main</code> function in
<a href="https://github.com/jichu4n/basic_wm/blob/master/main.cpp"><code>main.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#include &lt;cstdlib&gt;</span>
<span class="cp">#include &lt;glog/logging.h&gt;</span>
<span class="cp">#include &quot;window_manager.hpp&quot;</span>

<span class="k">using</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">::</span><span class="n">google</span><span class="o">::</span><span class="n">InitGoogleLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">window_manager</span><span class="p">(</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">Create</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">window_manager</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to initialize window manager.&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">window_manager</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Even if you have never programmed Xlib before, this should not be hard to
understand. <code>WindowManager::Create()</code> is a
<a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.xml#Doing_Work_in_Constructors">static
factory method</a> that sets up a connection to an X server via
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XOpenDisplay()</code></a>;
we will let
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XOpenDisplay()</code></a>
figure out which X server to connect to from the <code>DISPLAY</code> environment variable.
The connection is represented by the opaque <code>Display</code> structure. We call
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XCloseDisplay()</code></a>
on the saved <code>Display*</code> in the destructor to close the connection.</p></div>
<div class="paragraph"><p>The other function of note is
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/AllPlanes.3.html"><code>DefaultRootWindow()</code></a>,
which returns the default root window for a given X server. Technically, an X
server may have several root windows in some rare multihead setups, but let&#8217;s
not worry about that here.</p></div>
<div class="paragraph"><p>If you run this program now, it should connect to the X server, close the
connection, and exit. Hooray!</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_initialization">Step 2: Initialization</h3>
<div class="paragraph"><p>Now, let&#8217;s dig into the mysterious <code>Run()</code> function above. We&#8217;ll start with the
initialization steps required after opening an X server connection.
In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.hpp"><code>window_manager.hpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">WindowManager</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Xlib error handler. It must be static as its address is passed to Xlib.</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">OnXError</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">);</span>
  <span class="c1">// Xlib error handler used to determine whether another window manager is</span>
  <span class="c1">// running. It is set as the error handler right before selecting substructure</span>
  <span class="c1">// redirection mask on the root window, so it is invoked if and only if</span>
  <span class="c1">// another window manager is running. It must be static as its address is</span>
  <span class="c1">// passed to Xlib.</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="nf">OnWMDetected</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">);</span>
  <span class="c1">// Whether an existing window manager has been detected. Set by OnWMDetected,</span>
  <span class="c1">// and hence must be static.</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">wm_detected_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Initialization.</span>
  <span class="c1">//   a. Select events on root window. Use a special error handler so we can</span>
  <span class="c1">//   exit gracefully if another window manager is already running.</span>
  <span class="n">wm_detected_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">XSetErrorHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">OnWMDetected</span><span class="p">);</span>
  <span class="n">XSelectInput</span><span class="p">(</span>
      <span class="n">display_</span><span class="p">,</span>
      <span class="n">root_</span><span class="p">,</span>
      <span class="n">SubstructureRedirectMask</span> <span class="o">|</span> <span class="n">SubstructureNotifyMask</span><span class="p">);</span>
  <span class="n">XSync</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">wm_detected_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Detected another window manager on display &quot;</span>
               <span class="o">&lt;&lt;</span> <span class="n">XDisplayString</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//   b. Set error handler.</span>
  <span class="n">XSetErrorHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">OnXError</span><span class="p">);</span>

  <span class="c1">// 2. Main event loop.</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnWMDetected</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// In the case of an already running window manager, the error code from</span>
  <span class="c1">// XSelectInput is BadAccess. We don&#39;t expect this handler to receive any</span>
  <span class="c1">// other errors.</span>
  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">),</span> <span class="n">BadAccess</span><span class="p">);</span>
  <span class="c1">// Set flag.</span>
  <span class="n">wm_detected_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">// The return value is ignored.</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnXError</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Print e */</span> <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We first select substructure redirection and substructure notify events on the
root window. This is discussed in more detail in the
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#substructure-redirection">Substructure
Redirection</a> section in Part I; to recap, this allows the window manager to
intercept requests from top level windows, and subscribe to events concerning the
same. Only one X client can select substructure redirection on the root window
at any given time; the second client to attempt to do so will get a <code>BadAccess</code>
error.</p></div>
<div class="paragraph"><p>Catching this error is somewhat tricky, however.
<a href="http://manpages.ubuntu.com/manpages/en/man3/XSelectInput.3.html"><code>XSelectInput</code></a>,
like all asynchronous Xlib functions, does not actually send a request to the X
server, but instead only <em>queues</em> the request and returns. Hence, we have to
explicitly flush the request queue with
<a href="http://manpages.ubuntu.com/manpages/en/man3/XSync.3.html"><code>XSync</code></a> (see our
discussion above in <a href="#a-tale-of-two-x-libraries">A Tale of Two X Libraries</a>).
We set up a temporary error handler, <code>OnWMDetected</code>, to catch errors during this
<code>XSync</code> invocation.</p></div>
<div class="paragraph"><p>Next, we set up our regular error handler which will be invoked for any future
errors. Our implementation, which logs the error and continues, will be an
important debugging aid as we implement and test our window manager. I will not
show it here for the sake of brevity; for reference, check it out in
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_the_event_loop">Step 3: The Event Loop</h3>
<div class="paragraph"><p>Now let&#8217;s add to <code>Run()</code> method above the signature construct of every modern
GUI program - the event loop. In
<a href="https://github.com/jichu4n/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Initialization.</span>
  <span class="p">...</span>

  <span class="c1">// 2. Main event loop.</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="c1">// 1. Get next event.</span>
    <span class="n">XEvent</span> <span class="n">e</span><span class="p">;</span>
    <span class="n">XNextEvent</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">);</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Received event: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ToString</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

    <span class="c1">// 2. Dispatch event.</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">CreateNotify</span><span class="p">:</span>
        <span class="n">OnCreateNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xcreatewindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">DestroyNotify</span><span class="p">:</span>
        <span class="n">OnDestroyNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xdestroywindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">ReparentNotify</span><span class="p">:</span>
        <span class="n">OnReparentNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xreparent</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
      <span class="c1">// etc. etc.</span>
      <span class="p">...</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ignored event&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If you have done low-level GUI programming before, this should look very
familiar. We sit in an event loop and repeatedly fetch the next event with
<a href="http://manpages.ubuntu.com/manpages/en/man3/XNextEvent.3.html"><code>XNextEvent()</code></a> and
dispatch it to the appropriate handlers.</p></div>
<div class="paragraph"><p>The structure of the <code>XEvent</code> type is typical of a polymorphic C structure.
Each type of event carries different attributes and corresponds to an event
<code>struct</code>, such as <code>XKeyEvent</code>, <code>XButtonEvent</code>, and <code>XConfigureEvent</code>. The first
field of each <code>struct</code> is always <code>int type</code>. The <code>XEvent</code> type is a C
<code>union</code> of all the event <code>structs</code> plus <code>int type</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_XKeyEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="c1">// Fields specific to XKeyEvent.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XKeyEvent</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_XButtonEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="c1">// Fields specific to XButtonEvent.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XButtonEvent</span><span class="p">;</span>

<span class="c1">// etc.</span>
<span class="p">...</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="n">_XEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="n">XKeyEvent</span> <span class="n">xkey</span><span class="p">;</span>
  <span class="n">XButtonEvent</span> <span class="n">xbutton</span><span class="p">;</span>
  <span class="c1">// etc.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XEvent</span><span class="p">;</span>
</pre></div></div></div>
<div class="paragraph"><p>This way, the type is always available regardless of the type of event and
requires no additional storage. The same pattern can be observed in
<a href="http://en.wikipedia.org/wiki/GObject">GTK+/GLib</a>,
<a href="https://docs.python.org/3/c-api/structures.html">Python&#8217;s C API</a>, and many other
object-oriented C APIs.</p></div>
<div class="paragraph"><p>In <code>basic_wm</code>, the event handlers follow the naming convention of <code>OnFoo()</code>,
where <code>Foo</code> is the type of the event, so it should be straightforward to figure
out who does what.</p></div>
</div>
<div class="sect2">
<h3 id="_what_8217_s_next">What&#8217;s Next</h3>
<div class="paragraph"><p>We now have a basic skeleton for our window manager, and we can start filling in
the meat - the event handlers. The million-dollar question is, what events does
a window manager handle, and what should it do with them?</p></div>
<div class="paragraph"><p>In the <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">
next installment</a> in this series, we&#8217;ll answer that question by diving
into the complex ways window managers, clients and the user interact with each
other via X events. In the meantime, you&#8217;re more than welcome to check out the
code for <code>basic_wm</code> <a href="https://github.com/jichu4n/basic_wm">on GitHub</a>.</p></div>
<div class="paragraph"><p><strong>Next chapter:</strong>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html"><strong>How X
Window Managers Work, And How To Write One (Part III)</strong></a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part I: Basic Concepts</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html"><strong>Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</strong></a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">Part III: Interaction with Application Windows</a>
</p>
</li>
</ul></div>
</div></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Jun 08, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html" rel="bookmark">
      DEBUG trap and PROMPT_COMMAND in Bash
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-06-08T11:50:00-07:00">
          Jun 08, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/linux.html">Linux</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="exampleblock">
<div class="content">
<div class="paragraph"><p><strong>Update 03/08/2016</strong>: A
<a href="https://lists.gnu.org/archive/html/bug-bash/2015-10/msg00247.html">patch</a> by
Dan Stromberg adds a <code>PS0</code> variable to Bash that greatly simplifies what&#8217;s
described in this article. This patch will likely be merged into Bash 4.4.
Please refer to <a href="http://stromberg.dnsalias.org/~strombrg/PS0-prompt/">his
post</a> for details.</p></div>
</div></div>
<div class="sect2">
<h3 id="_the_debug_trap">The DEBUG trap</h3>
<div class="paragraph"><p>The DEBUG trap is an extremely handy feature of Bash. The idea is pretty
straightforward: if you run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">trap</span> <span class="s2">&quot;echo Hello&quot;</span> DEBUG
</pre></div></div></div>
<div class="paragraph"><p>then Bash will run <code>echo Hello</code> before it executes each subsequent command. For
example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ ls
Hello
file1 file2
~/Scratch $ echo Bye
Hello
Bye</code></pre>
</div></div>
<div class="paragraph"><p>A caveat, however, is that the DEBUG trap is triggered once per <em>simple</em>
command; if you have command lists or control structures, the trap will be
triggered multiple times. For example, using the setup above:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1 &amp;&amp; echo 2; echo 3
Hello
1
Hello
2
Hello
3
~/Scratch $ if [ -e /etc/passwd ]; then echo "/etc/passwd exists"; fi
Hello
Hello
/etc/passwd exists</code></pre>
</div></div>
<div class="paragraph"><p>What if we only want to run a command once per composite command, like the
<a href="http://zsh.sourceforge.net/Doc/Release/Functions.html"><code>preexec</code></a> hook in
<a href="http://en.wikipedia.org/wiki/Z_shell">zsh</a>?</p></div>
<div class="paragraph"><p>Enter <code>PROMPT_COMMAND</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_prompt_command">PROMPT_COMMAND</h3>
<div class="paragraph"><p>The idea behind <code>PROMPT_COMMAND</code> is also very simple: if you run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;echo Bye&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>then Bash will execute <code>echo Bye</code> before it prints each subsequent prompt (i.e.,
after it has finished executing the previous command line). For example, using
the setup above:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1; echo 2
Hello
1
Hello
2
Hello
Bye</code></pre>
</div></div>
<div class="paragraph"><p>Note that the DEBUG trap is triggered again for <code>PROMPT_COMMAND</code>, in addition to
the user-supplied commands.</p></div>
</div>
<div class="sect2">
<h3 id="_combining_the_debug_trap_and_code_prompt_command_code">Combining the DEBUG trap and <code>PROMPT_COMMAND</code></h3>
<div class="paragraph"><p>By combining the DEBUG trap and <code>PROMPT_COMMAND</code>, we can now hack Bash to
run some code right before and right after executing a full command. For
example, try adding this to your <code>~/.bashrc</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># This will run before any command is executed.</span>
<span class="k">function</span> PreCommand<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$AT_PROMPT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nb">unset </span>AT_PROMPT

  <span class="c"># Do stuff.</span>
  <span class="nb">echo</span> <span class="s2">&quot;Running PreCommand&quot;</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s2">&quot;PreCommand&quot;</span> DEBUG

<span class="c"># This will run after the execution of the previous full command line.  We don&#39;t</span>
<span class="c"># want it PostCommand to execute when first starting a bash session (i.e., at</span>
<span class="c"># the first prompt).</span>
<span class="nv">FIRST_PROMPT</span><span class="o">=</span>1
<span class="k">function</span> PostCommand<span class="o">()</span> <span class="o">{</span>
  <span class="nv">AT_PROMPT</span><span class="o">=</span>1

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$FIRST_PROMPT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">unset </span>FIRST_PROMPT
    <span class="k">return</span>
  <span class="k">fi</span>

  <span class="c"># Do stuff.</span>
  <span class="nb">echo</span> <span class="s2">&quot;Running PostCommand&quot;</span>
<span class="o">}</span>
<span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;PostCommand&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>The result:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1; echo 2 &amp;&amp; echo 3
Running PreCommand
1
2
3
Running PostCommand</code></pre>
</div></div>
<div class="paragraph"><p>This gives rise to some neat applications, such as
<a href="https://github.com/jichuan89/bash-command-timer">a command timer script</a> I wrote that
prints out the execution time of each command: <div align="center"><img
src="/assets/files/bash_command_timer_screenshot.gif" style="max-width: 657px;
width: 100%"></div>
Please feel free to
<a href="https://github.com/jichuan89/bash-command-timer">check it out on GitHub</a> :)</p></div>
<div class="paragraph"><p>Happy Bash hacking!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Jun 08, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/linux.html">Linux</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <!--- <li class="previous disabled"><a>&larr; Previous</a></li> -->
    <li class="next"><a href="https://seasonofcode.com/tag/featured2.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>